<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Directum Supply Co â€” Quote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#fafafa; color:#111; }
    header { padding:16px 20px; display:flex; gap:12px; align-items:center; background:#fff; border-bottom:1px solid #eee; position:sticky; top:0; z-index:10; }
    header input, header button { font-size:14px; padding:8px 10px; }
    header input { border:1px solid #ccc; border-radius:6px; min-width:240px; }
    header button { border:0; background:#111; color:#fff; border-radius:6px; cursor:pointer; }
    #message { padding:8px 20px; font-size:13px; }
    .container { display:grid; grid-template-columns: minmax(0,1fr) 360px; gap:20px; padding:20px; }
    #productGrid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .product-card { background:#fff; border:1px solid #eee; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
    .product-image { width:100%; padding-top:100%; background:#f3f3f3 center/contain no-repeat; }
    .product-info { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .product-name { font-weight:600; }
    .product-sku { color:#666; font-size:12px; }
    .pricing-tiers { display:grid; grid-template-columns: 1fr auto; gap:4px 10px; font-size:12px; }
    .quantity-controls { display:flex; align-items:center; gap:8px; }
    .qty-btn { width:28px; height:28px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .qty-input { width:64px; padding:6px 8px; border-radius:6px; border:1px solid #ddd; }
    .action-row { display:flex; gap:8px; flex-wrap:wrap; }
    .action-row button { font-size:12px; padding:6px 8px; border:1px solid #ddd; background:#fff; border-radius:6px; cursor:pointer; }
    aside { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; height:fit-content; position:sticky; top:80px; }
    .quote-item { border-top:1px dashed #eee; padding:8px 0; font-size:14px; }
    .totals { border-top:2px solid #111; margin-top:8px; padding-top:8px; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <header>
    <strong>Quote Builder</strong>
    <input id="customerEmail" placeholder="customer email (for S3 path)" />
    <input id="logoUrl" placeholder="logo URL (PNG with transparency best)" />
    <button onclick="loadProducts()">Reload Products</button>
    <div id="message"></div>
  </header>

  <div class="container">
    <main>
      <div id="productGrid"></div>
    </main>

    <aside>
      <h3>Quote</h3>
      <div id="quoteList"></div>
      <div class="totals">
        <div><strong>Subtotal:</strong> $<span id="subtotal">0.00</span></div>
        <div class="muted">Tax/shipping calculated at checkout</div>
      </div>
    </aside>
  </div>

  <script>
    let products = [];
    let quote = []; // { productId, name, unitPrice, quantity, totalPrice }

    function showMessage(msg, type='info') {
      const el = document.getElementById('message');
      el.textContent = msg || '';
      el.style.color = type === 'error' ? '#c00' : '#111';
    }

    async function loadProducts() {
      try {
        const email = document.getElementById('customerEmail').value.trim();
        const url = email ? `/api/products?customerEmail=${encodeURIComponent(email)}` : '/api/products';

        const resp = await fetch(url);
        const payload = await resp.json();

        // accept {products:[...]} or [...]
        products = Array.isArray(payload) ? payload : (payload.products || []);
        renderProducts(products);
        showMessage(`Loaded ${products.length} products`);
      } catch (err) {
        console.error('loadProducts error:', err);
        showMessage('Could not load products.', 'error');
        products = [];
        renderProducts(products);
      }
    }

    function priceFor(product, qty) {
      const q = Math.max(1, parseInt(qty,10)||1);
      const tier = (product.pricing||[]).find(p => q >= p.minQty && (p.maxQty===null || q <= p.maxQty));
      return tier ? tier.price : (product.pricing?.[0]?.price || 0);
    }

    function adjustQuantity(pid, delta) {
      const input = document.getElementById(`qty-${pid}`);
      const next = Math.max(0, (parseInt(input.value,10)||0) + delta);
      input.value = next;
      updateProductPricing(pid);
      updateQuote();
    }

    function updateProductPricing(pid) {
      const p = products.find(x => x.id === pid);
      const qty = Math.max(0, parseInt(document.getElementById(`qty-${pid}`).value,10)||0);
      const priceEl = document.getElementById(`price-${pid}`);
      const savingEl = document.getElementById(`savings-${pid}`);

      if (!p) return;
      if (qty === 0) {
        priceEl.textContent = `Starting at $${(p.currentPrice || p.pricing?.[0]?.price || 0).toFixed(2)}`;
        savingEl.style.display = 'none';
        return;
      }
      const unit = priceFor(p, qty);
      const total = unit * qty;
      const base = p.pricing?.[0]?.price || unit;
      const savings = Math.max(0, (base - unit) * qty);

      priceEl.textContent = `Qty ${qty} â€¢ $${unit.toFixed(2)} ea â€¢ $${total.toFixed(2)} total`;
      if (savings > 0.009) {
        savingEl.style.display = '';
        savingEl.textContent = `You save $${savings.toFixed(2)} vs 1-pc price`;
      } else {
        savingEl.style.display = 'none';
      }
    }

    function renderProducts(list) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = list.map(product => {
        const imageUrl = product.previewImageUrl || product.baseImageUrl || '';
        const imageStyle = imageUrl ? `style="background-image:url('${imageUrl}')" ` : '';
        const tiers = (product.pricingTable || []).map(tier => `
          <div class="pricing-tier" data-range="${tier.quantity_range}">
            <span>${tier.quantity_range}</span>
            <span>${tier.price_per_unit}</span>
          </div>
        `).join('');

        return `
          <div class="product-card">
            <div class="product-image" ${imageStyle} data-product-id="${product.id}">${imageUrl ? '' : 'ðŸ“·'}</div>
            <div class="product-info">
              <div class="product-name">${product.name}</div>
              <div class="product-sku">${product.sku}</div>
              <div class="product-desc">${product.description || ''}</div>
              <div class="pricing-tiers">${tiers}</div>

              <div class="quantity-controls">
                <button class="qty-btn" onclick="adjustQuantity('${product.id}', -1)">âˆ’</button>
                <input class="qty-input" id="qty-${product.id}" type="number" value="0" min="0"
                       onchange="updateProductPricing('${product.id}'); updateQuote()" />
                <button class="qty-btn" onclick="adjustQuantity('${product.id}', 1)">+</button>
              </div>
              <div class="product-price" id="price-${product.id}">
                Starting at $${(product.currentPrice || (product.pricing?.[0]?.price ?? 0)).toFixed(2)}
              </div>
              <div class="savings-badge" id="savings-${product.id}" style="display:none;"></div>

              <div class="action-row">
                <button onclick="runMockup('${product.id}')">Mockup & Upload</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // verify images and fall back to base if preview fails
      setTimeout(() => {
        list.forEach(product => {
          const tryUrl = product.previewImageUrl || product.baseImageUrl;
          if (!tryUrl) return;
          const testImg = new Image();
          testImg.onerror = () => {
            const card = document.querySelector(`[data-product-id="${product.id}"]`);
            if (card && product.baseImageUrl) {
              card.style.backgroundImage = `url('${product.baseImageUrl}')`;
            }
          };
          testImg.src = tryUrl;
        });
      }, 0);
    }

    function updateQuote() {
      quote = [];
      products.forEach(p => {
        const qty = Math.max(0, parseInt(document.getElementById(`qty-${p.id}`).value,10)||0);
        if (!qty) return;
        const unit = priceFor(p, qty);
        quote.push({
          productId: p.id,
          name: p.name,
          unitPrice: unit,
          quantity: qty,
          totalPrice: unit * qty
        });
      });

      const list = document.getElementById('quoteList');
      list.innerHTML = quote.map(item => `
        <div class="quote-item">
          <div><strong>${item.name}</strong></div>
          <div class="item-details">Qty ${item.quantity} Ã— $${item.unitPrice.toFixed(2)} = $${item.totalPrice.toFixed(2)}</div>
        </div>
      `).join('');

      const subtotal = quote.reduce((s, i) => s + i.totalPrice, 0);
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    }

    async function runMockup(productId) {
      try {
        const email = document.getElementById('customerEmail').value.trim();
        const logoUrl = document.getElementById('logoUrl').value.trim();
        if (!logoUrl) { showMessage('Please enter a logo URL first.', 'error'); return; }
        const resp = await fetch(`/api/products/${encodeURIComponent(productId)}/mockup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, logoUrl })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) {
          console.error('mockup error:', data);
          showMessage(`Mockup failed: ${data.error || 'unknown error'}`, 'error');
          return;
        }
        showMessage(data.uploaded ? `Uploaded to S3: ${data.url}` : 'Mockup created (no S3 config).');
        // reload products with same email to see preview
        await loadProducts();
      } catch (e) {
        console.error(e);
        showMessage('Mockup failed.', 'error');
      }
    }

    // boot
    loadProducts();
  </script>
</body>
</html>
