<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Corporate Apparel Quote Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Professional B2B Color Palette */
      --primary: #1a365d;        /* Deep navy blue */
      --primary-light: #2d5a87;  /* Lighter navy */
      --primary-dark: #0f2a44;   /* Darker navy */
      --accent: #e53e3e;         /* Professional red accent */
      --accent-light: #fc8181;   /* Light red */
      --accent-dark: #c53030;    /* Dark red */
      
      /* Neutral Grays */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* Surface Colors */
      --bg: #fafbfc;
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      
      /* Typography */
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-600);
      --text-muted: var(--gray-500);
      
      /* Spacing & Layout */
      --radius: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 72px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .logo::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      animation: logoShine 3s ease-in-out infinite;
    }

    @keyframes logoShine {
      0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .brand-text h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .brand-text p {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .email-input {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 12px 16px;
      min-width: 320px;
    }

    .email-input input {
      border: none;
      background: none;
      outline: none;
      font-size: 14px;
      color: var(--text-primary);
      flex: 1;
      font-weight: 500;
    }

    .email-input input::placeholder {
      color: var(--text-muted);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    /* Main Layout */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
      background: linear-gradient(135deg, var(--bg) 0%, #f8fafc 100%);
      min-height: calc(100vh - 72px);
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 32px;
      align-items: start;
    }

    /* Status Messages */
    .status-bar {
      margin-bottom: 24px;
    }

    .alert {
      padding: 16px 20px;
      border-radius: var(--radius);
      font-weight: 500;
      font-size: 14px;
      display: none;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid transparent;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert.success {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
      border-left-color: #22c55e;
    }

    .alert.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
      border-left-color: #ef4444;
    }

    .alert.show {
      display: block;
    }

    /* Product Catalog */
    .catalog {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--gray-200);
      position: relative;
    }

    .catalog::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--primary), var(--accent));
      background-size: 200% 100%;
      animation: gradientShift 4s ease-in-out infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .section-header {
      padding: 24px 28px;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--surface) 100%);
      position: relative;
    }

    .section-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 28px;
      right: 28px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .section-header p {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .products-grid {
      padding: 28px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    /* Product Cards */
    .product-card {
      background: var(--surface);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
      backdrop-filter: blur(10px);
    }

    .product-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(229, 62, 62, 0.02) 50%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1;
    }

    .product-card:hover::before {
      opacity: 1;
    }

    .product-card:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-4px);
      border-color: var(--gray-300);
      border-color: var(--accent);
    }

    .product-image {
      height: 280px;
      background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .product-image::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.1) 50%, transparent 51%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .product-content {
      padding: 24px;
      position: relative;
      z-index: 2;
    }

    .product-header {
      margin-bottom: 16px;
    }

    .product-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .product-sku {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .product-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    /* Pricing Tiers */
    .pricing-tiers {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
    }

    .pricing-tier {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .pricing-tier.active {
      background: var(--accent);
      color: white;
      font-weight: 600;
      transform: scale(1.02);
      box-shadow: var(--shadow-sm);
    }

    .pricing-tier:not(.active):hover {
      background: var(--gray-100);
    }

    /* Quantity Controls */
    .quantity-section {
      margin-bottom: 20px;
    }

    .quantity-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qty-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--gray-300);
      background: var(--surface);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .qty-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--gray-50);
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .qty-input {
      width: 80px;
      height: 40px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      background: var(--surface);
      outline: none;
      transition: all 0.2s ease;
    }

    .qty-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
      transform: scale(1.02);
    }

    /* Product Pricing Display */
    .product-pricing {
      margin-bottom: 16px;
    }

    .current-price {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .price-breakdown {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .savings {
      font-size: 13px;
      color: #059669;
      font-weight: 600;
      margin-top: 4px;
    }

    /* Quote Sidebar */
    .quote-sidebar {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 24px;
      max-height: calc(100vh - 48px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }

    .quote-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 20px 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .quote-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .quote-header h2 {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .quote-header p {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }

    .quote-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      flex-shrink: 0;
      background: var(--surface);
    }

    .quote-section:last-child {
      border-bottom: none;
    }

    .quote-section h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quote-section h3::before {
      content: '';
      width: 3px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
    }

    /* Tax Calculator */
    .tax-calculator {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .zip-input {
      flex: 1;
      height: 40px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 0 12px;
      font-size: 14px;
      font-weight: 500;
      outline: none;
      transition: all 0.2s ease;
      background: var(--gray-50);
    }

    .zip-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
      background: var(--surface);
      transform: scale(1.02);
    }

    .btn-secondary {
      background: var(--primary);
      color: var(--text-primary);
      border: none;
      border-radius: var(--radius);
      padding: 0 14px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Quote Items */
    .quote-items {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 0 28px;
    }

    .quote-items-wrapper {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .quote-items {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: 8px 20px 16px;
      max-height: 280px;
    }

    .quote-items::-webkit-scrollbar {
      width: 6px;
    }

    .quote-items::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 3px;
    }

    .quote-items::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 3px;
    }

    .quote-items::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    .quote-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
      border-radius: var(--radius);
      margin-bottom: 8px;
      background: var(--gray-50);
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .quote-item:hover {
      background: var(--surface);
      border-color: var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .quote-item:last-child {
      margin-bottom: 0;
    }

    .item-details h4 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      line-height: 1.3;
    }

    .item-meta {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity-badge {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .item-price {
      text-align: right;
      flex-shrink: 0;
    }

    .item-total {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .item-unit {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .remove-btn {
      background: none;
      border: 1px solid var(--gray-300);
      color: var(--accent);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 0.2s ease;
      opacity: 0.7;
    }

    .remove-btn:hover {
      background: var(--accent);
      color: white;
      opacity: 1;
      transform: translateY(-1px);
    }

    /* Quote Totals */
    .quote-totals {
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--surface) 100%);
      padding: 20px 20px 16px;
      flex-shrink: 0;
      border-top: 2px solid var(--gray-200);
      position: relative;
    }

    .quote-totals::before {
      content: '';
      position: absolute;
      top: 0;
      left: 20px;
      right: 20px;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--primary));
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 15px;
      font-weight: 500;
      padding: 4px 0;
    }

    .total-line:last-child {
      margin-bottom: 0;
      padding-top: 12px;
      border-top: 2px solid var(--gray-300);
      font-size: 22px;
      font-weight: 800;
      color: var(--text-primary);
      background: var(--surface);
      margin: 12px -20px -16px;
      padding: 16px 20px;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }

    .total-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .total-line:last-child .total-value {
      color: var(--accent);
      font-size: 24px;
    }

    .empty-quote {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-muted);
      background: var(--gray-50);
      border-radius: var(--radius);
      margin: 8px 0;
      border: 2px dashed var(--gray-300);
    }

    .empty-quote-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .empty-quote p {
      font-size: 14px;
      font-weight: 500;
    }

    /* Invoice Section */
    .invoice-section {
      padding: 16px 20px 20px;
      background: var(--surface);
      flex-shrink: 0;
    }

    .btn-invoice {
      width: 100%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      padding: 14px 24px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-invoice:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
      background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
    }

    .btn-invoice:active {
      transform: translateY(0);
    }

    .btn-invoice:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-invoice::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-invoice:hover::before {
      left: 100%;
    }

    .btn-icon {
      font-size: 18px;
    }

    .invoice-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 10px;
      font-weight: 500;
      text-align: center;
      font-style: italic;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: 1fr 340px;
        gap: 24px;
      }
      
      .products-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }
    }

    @media (max-width: 968px) {
      .layout {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .quote-sidebar {
        position: static;
        order: -1;
      }
      
      .products-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .container {
        padding: 20px 16px;
      }
      
      .header-content {
        padding: 0 16px;
        flex-direction: column;
        height: auto;
        padding-top: 16px;
        padding-bottom: 16px;
        gap: 16px;
      }
      
      .email-input {
        min-width: 280px;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
        padding: 20px;
        gap: 20px;
      }
      
      .product-image {
        height: 240px;
      }
    }

    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--gray-300);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 1000;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Floating Action Hints */
    .floating-hint {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: var(--shadow-xl);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
      pointer-events: none;
    }

    .floating-hint.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Enhanced Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .product-card {
      animation: fadeInUp 0.6s ease-out;
    }

    .product-card:nth-child(1) { animation-delay: 0.1s; }
    .product-card:nth-child(2) { animation-delay: 0.2s; }
    .product-card:nth-child(3) { animation-delay: 0.3s; }
    .product-card:nth-child(4) { animation-delay: 0.4s; }
    .product-card:nth-child(5) { animation-delay: 0.5s; }
    .product-card:nth-child(6) { animation-delay: 0.6s; }

    /* Improved Focus States */
    *:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Better Selection Colors */
    ::selection {
      background: var(--accent);
      color: white;
    }

    /* Smooth Page Transitions */
    * {
      scroll-behavior: smooth;
    }

    /* Invoice Panel Styles */
    .invoice-panel {
      position: fixed;
      top: 0;
      right: -600px;
      width: 600px;
      height: 100vh;
      background: var(--surface);
      box-shadow: var(--shadow-xl);
      z-index: 1000;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .invoice-panel.active {
      right: 0;
    }

    .invoice-panel-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .panel-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title-icon {
      font-size: 24px;
    }

    .panel-title h2 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }

    .close-panel-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .close-panel-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .invoice-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .progress-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 32px;
      padding: 0 20px;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      opacity: 0.5;
      transition: opacity 0.3s ease;
    }

    .step.active {
      opacity: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-300);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .step.active .step-circle {
      background: var(--accent);
      color: white;
    }

    .step span {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .step.active span {
      color: var(--text-primary);
      font-weight: 600;
    }

    .step-line {
      width: 60px;
      height: 2px;
      background: var(--gray-300);
      margin: 0 16px;
    }

    .invoice-step {
      display: none;
    }

    .invoice-step.active {
      display: block;
    }

    .step-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .step-header h3 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .step-header p {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select {
      height: 44px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 0 12px;
      font-size: 14px;
      font-weight: 500;
      outline: none;
      transition: all 0.2s ease;
      background: var(--surface);
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }

    .address-tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .same-address-toggle {
      margin-bottom: 20px;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .toggle-slider {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--gray-300);
      border-radius: 12px;
      transition: background 0.3s ease;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    input[type="checkbox"]:checked + .toggle-slider {
      background: var(--accent);
    }

    input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(20px);
    }

    input[type="checkbox"] {
      display: none;
    }

    .invoice-preview-card {
      background: var(--surface);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow);
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--gray-200);
    }

    .company-info h2 {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .company-info p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .invoice-meta h1 {
      font-size: 36px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 16px;
      text-align: right;
    }

    .invoice-details {
      text-align: right;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .detail-row span:first-child {
      font-weight: 600;
      color: var(--text-primary);
      margin-right: 20px;
    }

    .detail-row span:last-child {
      color: var(--text-secondary);
    }

    .customer-info-preview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 32px;
    }

    .bill-to h4,
    .ship-to h4 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .bill-to div,
    .ship-to div {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }

    .items-table th {
      background: var(--gray-50);
      padding: 12px;
      text-align: left;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--gray-200);
    }

    .items-table td {
      padding: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--gray-200);
    }

    .items-table th:last-child,
    .items-table td:last-child {
      text-align: right;
    }

    .invoice-totals-preview {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      min-width: 200px;
      font-size: 16px;
      font-weight: 500;
    }

    .totals-row.total {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      padding-top: 12px;
      border-top: 2px solid var(--gray-300);
      margin-top: 8px;
    }

    .invoice-panel-footer {
      background: var(--gray-50);
      padding: 20px 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .btn-success {
      background: #059669;
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover {
      background: #047857;
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    .panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .invoice-panel.active + .panel-overlay {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">CA</div>
        <div class="brand-text">
          <h1>Corporate Apparel</h1>
          <p>Professional Quote Tool</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="email-input">
          <input id="toolbarEmail" type="email" placeholder="Enter customer email for branded mockups"/>
          <button class="btn-primary" onclick="reloadWithEmail()">Load Mockups</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Status Messages -->
    <div class="status-bar">
      <div id="statusMsg" class="alert success"></div>
      <div id="errorMsg" class="alert error"></div>
    </div>

    <div class="layout">
      <!-- Product Catalog -->
      <div class="catalog">
        <div class="section-header">
          <h2>Corporate Apparel Catalog</h2>
          <p>Professional branded apparel with volume pricing. Minimum order: 24 pieces per item.</p>
        </div>
        <div id="productGrid" class="products-grid"></div>
      </div>

      <!-- Quote Sidebar -->
      <div class="quote-sidebar">
        <div class="quote-header">
          <h2>Your Quote</h2>
          <p>Instant pricing with volume discounts</p>
        </div>

        <div class="quote-section">
          <h3>Tax Calculator</h3>
          <div class="tax-calculator">
            <input id="zipCode" class="zip-input" type="text" placeholder="ZIP code" maxlength="10"/>
            <button class="btn-secondary" onclick="calculateTax()">Calculate</button>
          </div>
          <div id="taxResult" style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;"></div>
        </div>

        <div class="quote-section" style="padding-bottom: 8px;">
          <h3>Quote Items</h3>
        </div>

        <div class="quote-items-wrapper">
          <div id="quoteItems" class="quote-items">
            <div class="empty-quote">
              <div class="empty-quote-icon">📋</div>
              <p>Add quantities above to build your quote</p>
            </div>
          </div>
        </div>

        <div class="quote-totals">
          <div class="total-line">
            <span>Subtotal</span>
            <span id="subtotalAmount" class="total-value">$0.00</span>
          </div>
          <div class="total-line">
            <span>Shipping</span>
            <span class="total-value" style="color: #059669;">FREE</span>
          </div>
          <div class="total-line">
            <span>Tax</span>
            <span id="taxAmount" class="total-value">$0.00</span>
          </div>
          <div class="total-line">
            <span>Total Quote</span>
            <span id="totalAmount">$0.00</span>
          </div>
        </div>
        
        <div id="invoiceSection" class="invoice-section" style="display: none;">
          <button id="createInvoiceBtn" class="btn-invoice" onclick="createInvoice()">
            <span class="btn-icon">📄</span>
            Create Invoice
          </button>
          <p class="invoice-note">Generate a professional invoice for this quote</p>
        </div>
      </div>
    </div>

    <!-- Slide-out Invoice Panel -->
    <div id="invoicePanel" class="invoice-panel">
      <div class="invoice-panel-header">
        <div class="panel-title">
          <div class="title-icon">🧾</div>
          <h2>Generate Invoice</h2>
        </div>
        <button id="closePanelBtn" class="close-panel-btn">✕</button>
      </div>
      
      <div class="invoice-panel-content">
        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step active" data-step="1">
            <div class="step-circle">1</div>
            <span>Customer</span>
          </div>
          <div class="step-line"></div>
          <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <span>Address</span>
          </div>
          <div class="step-line"></div>
          <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <span>Review</span>
          </div>
        </div>

        <!-- Step 1: Customer Information -->
        <div class="invoice-step active" id="step1">
          <div class="step-header">
            <h3>Customer Information</h3>
            <p>Enter your customer's business details</p>
          </div>
          
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="companyName">Company Name *</label>
              <input type="text" id="companyName" placeholder="Acme Corporation" required>
            </div>
            
            <div class="form-group">
              <label for="contactName">Contact Person *</label>
              <input type="text" id="contactName" placeholder="John Smith" required>
            </div>
            
            <div class="form-group">
              <label for="customerEmail">Email Address *</label>
              <input type="email" id="customerEmail" placeholder="john@acme.com" required>
            </div>
            
            <div class="form-group">
              <label for="customerPhone">Phone Number</label>
              <input type="tel" id="customerPhone" placeholder="+1 (555) 123-4567">
            </div>
            
            <div class="form-group">
              <label for="customerWebsite">Website</label>
              <input type="url" id="customerWebsite" placeholder="https://acme.com">
            </div>
          </div>
        </div>

        <!-- Step 2: Address Information -->
        <div class="invoice-step" id="step2">
          <div class="step-header">
            <h3>Billing & Shipping Address</h3>
            <p>Where should we send the invoice and products?</p>
          </div>
          
          <div class="address-tabs">
            <button class="tab-btn active" data-tab="billing">Billing Address</button>
            <button class="tab-btn" data-tab="shipping">Shipping Address</button>
          </div>
          
          <div class="tab-content active" id="billingTab">
            <div class="form-grid">
              <div class="form-group full-width">
                <label for="billingStreet">Street Address *</label>
                <input type="text" id="billingStreet" placeholder="123 Business Ave" required>
              </div>
              
              <div class="form-group">
                <label for="billingCity">City *</label>
                <input type="text" id="billingCity" placeholder="New York" required>
              </div>
              
              <div class="form-group">
                <label for="billingState">State *</label>
                <input type="text" id="billingState" placeholder="NY" required>
              </div>
              
              <div class="form-group">
                <label for="billingZip">ZIP Code *</label>
                <input type="text" id="billingZip" placeholder="10001" required>
              </div>
              
              <div class="form-group">
                <label for="billingCountry">Country *</label>
                <select id="billingCountry" required>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="tab-content" id="shippingTab">
            <div class="same-address-toggle">
              <label class="toggle-label">
                <input type="checkbox" id="sameAsbilling">
                <span class="toggle-slider"></span>
                Same as billing address
              </label>
            </div>
            
            <div class="form-grid" id="shippingForm">
              <div class="form-group full-width">
                <label for="shippingStreet">Street Address *</label>
                <input type="text" id="shippingStreet" placeholder="123 Delivery St" required>
              </div>
              
              <div class="form-group">
                <label for="shippingCity">City *</label>
                <input type="text" id="shippingCity" placeholder="New York" required>
              </div>
              
              <div class="form-group">
                <label for="shippingState">State *</label>
                <input type="text" id="shippingState" placeholder="NY" required>
              </div>
              
              <div class="form-group">
                <label for="shippingZip">ZIP Code *</label>
                <input type="text" id="shippingZip" placeholder="10001" required>
              </div>
              
              <div class="form-group">
                <label for="shippingCountry">Country *</label>
                <select id="shippingCountry" required>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Invoice Preview -->
        <div class="invoice-step" id="step3">
          <div class="step-header">
            <h3>Invoice Preview</h3>
            <p>Review your invoice before generating</p>
          </div>
          
          <div class="invoice-preview-card">
            <div class="invoice-header">
              <div class="company-info">
                <h2>Your Company Name</h2>
                <p>123 Business Street<br>City, State 12345<br>contact@company.com</p>
              </div>
              <div class="invoice-meta">
                <h1>INVOICE</h1>
                <div class="invoice-details">
                  <div class="detail-row">
                    <span>Invoice #:</span>
                    <span id="invoiceNumber">INV-001</span>
                  </div>
                  <div class="detail-row">
                    <span>Date:</span>
                    <span id="invoiceDate"></span>
                  </div>
                  <div class="detail-row">
                    <span>Due Date:</span>
                    <span id="invoiceDueDate"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="customer-info-preview">
              <div class="bill-to">
                <h4>Bill To:</h4>
                <div id="billToPreview"></div>
              </div>
              <div class="ship-to">
                <h4>Ship To:</h4>
                <div id="shipToPreview"></div>
              </div>
            </div>
            
            <div class="invoice-items-preview">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>SKU</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsPreview">
                </tbody>
              </table>
            </div>
            
            <div class="invoice-totals-preview">
              <div class="totals-row">
                <span>Subtotal:</span>
                <span id="previewSubtotal">$0.00</span>
              </div>
              <div class="totals-row">
                <span>Tax:</span>
                <span id="previewTax">$0.00</span>
              </div>
              <div class="totals-row total">
                <span>Total:</span>
                <span id="previewTotal">$0.00</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="invoice-panel-footer">
        <button id="prevStepBtn" class="btn-secondary" style="display: none;">Previous</button>
        <button id="nextStepBtn" class="btn-primary">Next Step</button>
        <button id="generateInvoiceBtn" class="btn-success" style="display: none;">Generate Invoice</button>
      </div>
    </div>
    
    <div id="panelOverlay" class="panel-overlay"></div>
  </div>

  <!-- Floating Hint -->
  <div id="floatingHint" class="floating-hint">
    💡 Add quantities to see volume discounts!
  </div>

  <script>
    // State Management
    let products = [];
    let quote = [];
    let taxRate = 0;
    let taxAmount = 0;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      const usp = new URLSearchParams(window.location.search);
      if (usp.get('success')) showStatus('Payment successful.');
      if (usp.get('canceled')) showError('Payment canceled.');
      await loadProducts();
      updateQuoteDisplay();
      showFloatingHint();
    });

    // Utility Functions
    function showStatus(message) {
      const el = document.getElementById('statusMsg');
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 5000);
    }

    function showError(message) {
      const el = document.getElementById('errorMsg');
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 8000);
    }

    function showFloatingHint() {
      const hint = document.getElementById('floatingHint');
      setTimeout(() => {
        hint.classList.add('show');
        setTimeout(() => {
          hint.classList.remove('show');
        }, 4000);
      }, 2000);
    }

    function mirrorEmail() {
      const customerEmail = document.getElementById('customerEmail')?.value?.trim();
      if (customerEmail) {
        document.getElementById('toolbarEmail').value = customerEmail;
        loadProducts();
      }
    }

    async function reloadWithEmail() {
      await loadProducts();
    }

    // Product Loading
    async function loadProducts() {
      try {
        const email = document.getElementById('toolbarEmail').value.trim();
        const url = email ? `/api/products?customerEmail=${encodeURIComponent(email)}` : '/api/products';
        const response = await fetch(url);
        products = await response.json();
        renderProducts();
      } catch (error) {
        console.error('Failed to load products:', error);
        showError('Failed to load products. Please try again.');
        products = [];
        renderProducts();
      }
    }

    // Product Rendering
    function renderProducts() {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = products.map(product => {
        const imageStyle = product.previewImageUrl 
          ? `style="background-image: url('${product.previewImageUrl}')"` 
          : '';
        
        const tiers = (product.pricingTable || []).map(tier => `
          <div class="pricing-tier" data-range="${tier.quantity_range}">
            <span>${tier.quantity_range}</span>
            <span>${tier.price_per_unit}</span>
          </div>
        `).join('');

        return `
          <div class="product-card">
            <div class="product-image" ${imageStyle}>
              ${!product.previewImageUrl ? 'Branded mockup will appear here' : ''}
            </div>
            <div class="product-content">
              <div class="product-header">
                <h3 class="product-name">${product.name}</h3>
                <div class="product-sku">${product.sku}</div>
              </div>
              <p class="product-description">${product.description}</p>
              
              <div class="pricing-tiers">
                ${tiers}
              </div>

              <div class="quantity-section">
                <div class="quantity-label">Quantity</div>
                <div class="quantity-controls">
                  <button class="qty-btn" onclick="updateQuantity('${product.id}', -1)">−</button>
                  <input class="qty-input" id="qty-${product.id}" type="number" value="0" min="0" 
                         onchange="recalculateProduct('${product.id}')" />
                  <button class="qty-btn" onclick="updateQuantity('${product.id}', 1)">+</button>
                </div>
              </div>

              <div class="product-pricing">
                <div class="current-price" id="price-${product.id}">$0.00</div>
                <div class="price-breakdown" id="breakdown-${product.id}">Select quantity for pricing</div>
                <div class="savings" id="savings-${product.id}"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Initialize all product calculations
      products.forEach(product => recalculateProduct(product.id));
    }

    // Quantity Management
    function updateQuantity(productId, delta) {
      const input = document.getElementById(`qty-${productId}`);
      const currentQty = parseInt(input.value || '0', 10);
      const newQty = Math.max(0, currentQty + delta);
      input.value = newQty;
      recalculateProduct(productId);
    }

    function findUnitPrice(product, quantity) {
      const qty = Math.max(0, parseInt(quantity || '0', 10));
      if (qty === 0) return 0;
      
      const tier = product.pricing.find(p => 
        qty >= p.minQty && (p.maxQty === null || qty <= p.maxQty)
      );
      return tier ? tier.price : product.pricing[0].price;
    }

    function recalculateProduct(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const qty = parseInt(document.getElementById(`qty-${productId}`).value || '0', 10);
      const unitPrice = findUnitPrice(product, qty);
      const totalPrice = unitPrice * qty;

      // Update price display
      const priceEl = document.getElementById(`price-${product.id}`);
      const breakdownEl = document.getElementById(`breakdown-${product.id}`);
      const savingsEl = document.getElementById(`savings-${product.id}`);

      if (qty === 0) {
        priceEl.textContent = '$0.00';
        breakdownEl.textContent = 'Select quantity for pricing';
        savingsEl.textContent = '';
      } else {
        priceEl.textContent = `$${totalPrice.toFixed(2)}`;
        breakdownEl.textContent = `${qty} × $${unitPrice.toFixed(2)} each`;
        
        // Calculate savings
        const basePrice = product.pricing[0].price;
        const savings = (basePrice - unitPrice) * qty;
        savingsEl.textContent = savings > 0 ? `You save $${savings.toFixed(2)}` : '';
      }

      // Highlight active pricing tier
      const card = document.querySelector(`#qty-${productId}`).closest('.product-card');
      if (card) {
        card.querySelectorAll('.pricing-tier').forEach(tierEl => {
          const range = tierEl.dataset.range;
          const tier = product.pricing.find(p => {
            const rangeStr = p.maxQty ? `${p.minQty}-${p.maxQty}` : `${p.minQty}+`;
            return range === rangeStr;
          });
          const isActive = tier && qty >= tier.minQty && (tier.maxQty === null || qty <= tier.maxQty);
          tierEl.classList.toggle('active', isActive && qty > 0);
        });
      }

      updateQuoteItems();
    }

    // Quote Management
    function updateQuoteItems() {
      quote = [];
      
      products.forEach(product => {
        const qty = parseInt(document.getElementById(`qty-${product.id}`).value || '0', 10);
        if (qty > 0) {
          const unitPrice = findUnitPrice(product, qty);
          quote.push({
            productId: product.id,
            product: product,
            quantity: qty,
            unitPrice: unitPrice,
            totalPrice: unitPrice * qty
          });
        }
      });

      updateQuoteDisplay();
    }

    function updateQuoteDisplay() {
      const itemsContainer = document.getElementById('quoteItems');
      const subtotalEl = document.getElementById('subtotalAmount');
      const taxAmountEl = document.getElementById('taxAmount');
      const totalEl = document.getElementById('totalAmount');

      if (quote.length === 0) {
        itemsContainer.innerHTML = `
          <div class="empty-quote">
            <div class="empty-quote-icon">📋</div>
            <p>Add quantities above to build your quote</p>
          </div>
        `;
        subtotalEl.textContent = '$0.00';
        taxAmountEl.textContent = '$0.00';
        totalEl.textContent = '$0.00';
        return;
      }

      // Render quote items
      const itemsHtml = quote.map(item => `
        <div class="quote-item">
          <div class="item-details">
            <h4>${item.product.name}</h4>
            <div class="item-meta">
              <span class="quantity-badge">${item.quantity}</span>
              <span>× $${item.unitPrice.toFixed(2)} each</span>
            </div>
            <button class="remove-btn" onclick="removeFromQuote('${item.productId}')">Remove</button>
          </div>
          <div class="item-price">
            <div class="item-total">$${item.totalPrice.toFixed(2)}</div>
            <div class="item-unit">Total</div>
          </div>
        </div>
      `).join('');

      itemsContainer.innerHTML = itemsHtml;

      // Calculate totals
      const subtotal = quote.reduce((sum, item) => sum + item.totalPrice, 0);
      const calculatedTax = subtotal * taxRate;
      const total = subtotal + calculatedTax;

      subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
      taxAmountEl.textContent = `$${calculatedTax.toFixed(2)}`;
      totalEl.textContent = `$${total.toFixed(2)}`;

      taxAmount = calculatedTax;

      // Show/hide invoice section based on quote content
      const invoiceSection = document.getElementById('invoiceSection');
      if (invoiceSection) {
        invoiceSection.style.display = quote.length > 0 ? 'block' : 'none';
      }
    }

    function removeFromQuote(productId) {
      document.getElementById(`qty-${productId}`).value = '0';
      recalculateProduct(productId);
    }

    // Tax Calculator
    async function calculateTax() {
      const zipCode = document.getElementById('zipCode').value.trim();
      const taxResult = document.getElementById('taxResult');
      
      if (!zipCode) {
        taxResult.textContent = 'Please enter a ZIP code';
        return;
      }

      if (quote.length === 0) {
        taxResult.textContent = 'Add items to quote first';
        return;
      }

      try {
        taxResult.textContent = 'Calculating...';
        
        const response = await fetch('/api/calculate-tax', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            zipCode: zipCode,
            items: quote.map(item => ({
              productId: item.productId,
              quantity: item.quantity,
              unitPrice: item.unitPrice
            }))
          })
        });

        const data = await response.json();
        
        if (data.error) {
          taxResult.textContent = `Error: ${data.error}`;
          taxRate = 0;
        } else {
          taxRate = data.taxRate || 0;
          taxResult.textContent = `Tax rate: ${(taxRate * 100).toFixed(2)}% for ${zipCode}`;
        }
        
        updateQuoteDisplay();
      } catch (error) {
        console.error('Tax calculation failed:', error);
        taxResult.textContent = 'Tax calculation failed';
        taxRate = 0;
        updateQuoteDisplay();
      }
    }

    // Invoice Creation
    function createInvoice() {
      openInvoicePanel();
    }

    // Invoice Panel Functions
    let currentStep = 1;
    const maxSteps = 3;

    function openInvoicePanel() {
      if (quote.length === 0) {
        alert('Please add items to your quote first');
        return;
      }
      
      const customerEmail = document.getElementById('toolbarEmail').value.trim();
      if (customerEmail) {
        document.getElementById('customerEmail').value = customerEmail;
      }
      
      document.getElementById('invoicePanel').classList.add('active');
      document.body.style.overflow = 'hidden';
      updateInvoicePreview();
    }

    function closeInvoicePanel() {
      document.getElementById('invoicePanel').classList.remove('active');
      document.body.style.overflow = '';
      currentStep = 1;
      updateStepDisplay();
    }

    function nextStep() {
      if (currentStep < maxSteps) {
        if (validateCurrentStep()) {
          currentStep++;
          updateStepDisplay();
          if (currentStep === 3) {
            updateInvoicePreview();
          }
        }
      }
    }

    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
      }
    }

    function updateStepDisplay() {
      // Update step indicators
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.toggle('active', index + 1 === currentStep);
      });

      // Update step content
      document.querySelectorAll('.invoice-step').forEach((content, index) => {
        content.classList.toggle('active', index + 1 === currentStep);
      });

      // Update buttons
      const prevBtn = document.getElementById('prevStepBtn');
      const nextBtn = document.getElementById('nextStepBtn');
      const generateBtn = document.getElementById('generateInvoiceBtn');

      prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
      nextBtn.style.display = currentStep < maxSteps ? 'block' : 'none';
      generateBtn.style.display = currentStep === maxSteps ? 'block' : 'none';
    }

    function validateCurrentStep() {
      const requiredFields = [];
      
      if (currentStep === 1) {
        requiredFields.push('companyName', 'contactName', 'customerEmail');
      } else if (currentStep === 2) {
        requiredFields.push('billingStreet', 'billingCity', 'billingState', 'billingZip');
        if (!document.getElementById('sameAsbilling').checked) {
          requiredFields.push('shippingStreet', 'shippingCity', 'shippingState', 'shippingZip');
        }
      }

      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          field.focus();
          field.style.borderColor = '#dc3545';
          setTimeout(() => {
            field.style.borderColor = '';
          }, 3000);
          return false;
        }
      }
      
      return true;
    }

    function switchAddressTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`${tab}Tab`).classList.add('active');
    }

    function toggleSameAddress() {
      const checkbox = document.getElementById('sameAsbilling');
      const shippingForm = document.getElementById('shippingForm');
      
      if (checkbox.checked) {
        shippingForm.style.opacity = '0.5';
        shippingForm.style.pointerEvents = 'none';
        
        // Copy billing to shipping
        document.getElementById('shippingStreet').value = document.getElementById('billingStreet').value;
        document.getElementById('shippingCity').value = document.getElementById('billingCity').value;
        document.getElementById('shippingState').value = document.getElementById('billingState').value;
        document.getElementById('shippingZip').value = document.getElementById('billingZip').value;
        document.getElementById('shippingCountry').value = document.getElementById('billingCountry').value;
      } else {
        shippingForm.style.opacity = '';
        shippingForm.style.pointerEvents = '';
      }
    }

    function updateInvoicePreview() {
      // Update customer info
      const companyName = document.getElementById('companyName').value || 'Company Name';
      const contactName = document.getElementById('contactName').value || 'Contact Person';
      const email = document.getElementById('customerEmail').value || 'email@example.com';
      
      // Update addresses
      const billingAddress = [
        document.getElementById('billingStreet').value,
        `${document.getElementById('billingCity').value}, ${document.getElementById('billingState').value} ${document.getElementById('billingZip').value}`
      ].filter(Boolean).join('<br>');
      
      document.getElementById('billToPreview').innerHTML = billingAddress || 'Address will appear here';
      
      const shippingAddress = document.getElementById('sameAsbilling').checked ? 
        billingAddress : 
        [
          document.getElementById('shippingStreet').value,
          `${document.getElementById('shippingCity').value}, ${document.getElementById('shippingState').value} ${document.getElementById('shippingZip').value}`
        ].filter(Boolean).join('<br>');
      
      document.getElementById('shipToPreview').innerHTML = shippingAddress || 'Shipping address will appear here';
      
      // Update dates
      const today = new Date();
      const dueDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
      
      document.getElementById('invoiceDate').textContent = today.toLocaleDateString();
      document.getElementById('invoiceDueDate').textContent = dueDate.toLocaleDateString();
      
      // Update items table
      const tableBody = document.getElementById('invoiceItemsPreview');
      tableBody.innerHTML = '';
      
      let subtotal = 0;
      
      quote.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (product) {
          const total = item.unitPrice * item.quantity;
          subtotal += total;
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product.name}</td>
            <td>${product.sku}</td>
            <td>${item.quantity}</td>
            <td>$${item.unitPrice.toFixed(2)}</td>
            <td>$${total.toFixed(2)}</td>
          `;
          tableBody.appendChild(row);
        }
      });
      
      // Update totals
      const tax = subtotal * taxRate;
      const total = subtotal + tax;
      
      document.getElementById('previewSubtotal').textContent = `$${subtotal.toFixed(2)}`;
      document.getElementById('previewTax').textContent = `$${tax.toFixed(2)}`;
      document.getElementById('previewTotal').textContent = `$${total.toFixed(2)}`;
    }

    function finalizeInvoice() {
      alert('Invoice generated successfully! In a real implementation, this would generate a PDF and/or send an email.');
      closeInvoicePanel();
    }

    // Event Listeners
    document.getElementById('closePanelBtn').addEventListener('click', closeInvoicePanel);
    document.getElementById('prevStepBtn').addEventListener('click', previousStep);
    document.getElementById('nextStepBtn').addEventListener('click', nextStep);
    document.getElementById('generateInvoiceBtn').addEventListener('click', finalizeInvoice);
    document.getElementById('panelOverlay').addEventListener('click', closeInvoicePanel);

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        switchAddressTab(tab);
      });
    });

    // Same address toggle
    document.getElementById('sameAsbilling').addEventListener('change', toggleSameAddress);

    // Close panel with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('invoicePanel').classList.contains('active')) {
        closeInvoicePanel();
      }
    });

    // Auto-copy billing to shipping when billing fields change
    ['billingStreet', 'billingCity', 'billingState', 'billingZip', 'billingCountry'].forEach(fieldId => {
      document.addEventListener('DOMContentLoaded', function() {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            if (document.getElementById('sameAsbilling').checked) {
              const shippingFieldId = fieldId.replace('billing', 'shipping');
              const shippingField = document.getElementById(shippingFieldId);
              if (shippingField) {
                shippingField.value = this.value;
              }
            }
          });
        }
      });
    });
  </script>
</body>
</html>