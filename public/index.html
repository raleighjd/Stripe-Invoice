<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Corporate Apparel Quote Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Professional B2B Color Palette */
      --primary: #1a365d;        /* Deep navy blue */
      --primary-light: #2d5a87;  /* Lighter navy */
      --primary-dark: #0f2a44;   /* Darker navy */
      --accent: #e53e3e;         /* Professional red accent */
      --accent-light: #fc8181;   /* Light red */
      --accent-dark: #c53030;    /* Dark red */
      
      /* Neutral Grays */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* Surface Colors */
      --bg: #fafbfc;
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      
      /* Typography */
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-600);
      --text-muted: var(--gray-500);
      
      /* Spacing & Layout */
      --radius: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 72px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 20px;
      box-shadow: var(--shadow);
    }

    .brand-text h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .brand-text p {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .email-input {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 12px 16px;
      min-width: 320px;
    }

    .email-input input {
      border: none;
      background: none;
      outline: none;
      font-size: 14px;
      color: var(--text-primary);
      flex: 1;
      font-weight: 500;
    }

    .email-input input::placeholder {
      color: var(--text-muted);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    /* Main Layout */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 32px;
      align-items: start;
    }

    /* Status Messages */
    .status-bar {
      margin-bottom: 24px;
    }

    .alert {
      padding: 16px 20px;
      border-radius: var(--radius);
      font-weight: 500;
      font-size: 14px;
      display: none;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid transparent;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert.success {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
      border-left-color: #22c55e;
    }

    .alert.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
      border-left-color: #ef4444;
    }

    .alert.show {
      display: block;
    }

    /* Product Catalog */
    .catalog {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .section-header {
      padding: 24px 28px;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .section-header p {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .products-grid {
      padding: 28px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    /* Product Cards */
    .product-card {
      background: var(--surface);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
    }

    .product-card:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-4px);
      border-color: var(--gray-300);
    }

    .product-image {
      height: 280px;
      background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .product-image::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.1) 50%, transparent 51%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .product-content {
      padding: 24px;
    }

    .product-header {
      margin-bottom: 16px;
    }

    .product-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .product-sku {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .product-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    /* Pricing Tiers */
    .pricing-tiers {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
    }

    .pricing-tier {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .pricing-tier.active {
      background: var(--accent);
      color: white;
      font-weight: 600;
    }

    .pricing-tier:not(.active):hover {
      background: var(--gray-100);
    }

    /* Quantity Controls */
    .quantity-section {
      margin-bottom: 20px;
    }

    .quantity-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qty-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--gray-300);
      background: var(--surface);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .qty-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--gray-50);
    }

    .qty-input {
      width: 80px;
      height: 40px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      background: var(--surface);
      outline: none;
      transition: all 0.2s ease;
    }

    .qty-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }

    /* Product Pricing Display */
    .product-pricing {
      margin-bottom: 16px;
    }

    .current-price {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .price-breakdown {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .savings {
      font-size: 13px;
      color: #059669;
      font-weight: 600;
      margin-top: 4px;
    }

    /* Quote Sidebar */
    .quote-sidebar {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 24px;
      max-height: calc(100vh - 48px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .quote-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 24px 28px;
      text-align: center;
    }

    .quote-header h2 {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .quote-header p {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 500;
    }

    .quote-section {
      padding: 16px 28px;
      border-bottom: 1px solid var(--gray-200);
      flex-shrink: 0;
    }

    .quote-section:last-child {
      border-bottom: none;
    }

    .quote-section h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Tax Calculator */
    .tax-calculator {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .zip-input {
      flex: 1;
      height: 44px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 0 16px;
      font-size: 14px;
      font-weight: 500;
      outline: none;
      transition: all 0.2s ease;
    }

    .zip-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--text-primary);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 0 16px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn-secondary:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    /* Quote Items */
    .quote-items {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 0 28px;
    }

    .quote-items-wrapper {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .quote-items {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: 16px 28px;
      max-height: 300px;
    }

    .quote-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 16px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .quote-item:last-child {
      border-bottom: none;
    }

    .item-details h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .item-meta {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .item-price {
      text-align: right;
    }

    .item-total {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .item-unit {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .remove-btn {
      background: none;
      border: 1px solid var(--accent-light);
      color: var(--accent);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      transition: all 0.2s ease;
    }

    .remove-btn:hover {
      background: var(--accent);
      color: white;
    }

    /* Quote Totals */
    .quote-totals {
      background: var(--gray-50);
      padding: 16px 28px;
      flex-shrink: 0;
      border-top: 1px solid var(--gray-200);
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 500;
    }

    .total-line:last-child {
      margin-bottom: 0;
      padding-top: 16px;
      border-top: 2px solid var(--gray-200);
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary);
    }

    .total-value {
      font-weight: 600;
    }

    .empty-quote {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-quote-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Invoice Section */
    .invoice-section {
      padding: 16px 28px;
      background: var(--surface);
      border-top: 1px solid var(--gray-200);
      flex-shrink: 0;
    }

    .btn-invoice {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 16px 24px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .btn-invoice:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-invoice:active {
      transform: translateY(0);
    }

    .btn-invoice:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-invoice::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn-invoice:hover::before {
      left: 100%;
    }

    .btn-icon {
      font-size: 16px;
    }

    .invoice-note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      font-weight: 500;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: 1fr 340px;
        gap: 24px;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
    }

    @media (max-width: 968px) {
      .layout {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .quote-sidebar {
        position: static;
        order: -1;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
    }

    @media (max-width: 640px) {
      .container {
        padding: 20px 16px;
      }
      
      .header-content {
        padding: 0 16px;
        flex-direction: column;
        height: auto;
        padding-top: 16px;
        padding-bottom: 16px;
        gap: 16px;
      }
      
      .email-input {
        min-width: 280px;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
        padding: 20px;
        gap: 20px;
      }
      
      .product-image {
        height: 240px;
      }
    }

    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--gray-300);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">CA</div>
        <div class="brand-text">
          <h1>Corporate Apparel</h1>
          <p>Professional Quote Tool</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="email-input">
          <input id="toolbarEmail" type="email" placeholder="Enter customer email for branded mockups"/>
          <button class="btn-primary" onclick="reloadWithEmail()">Load Mockups</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Status Messages -->
    <div class="status-bar">
      <div id="statusMsg" class="alert success"></div>
      <div id="errorMsg" class="alert error"></div>
    </div>

    <div class="layout">
      <!-- Product Catalog -->
      <div class="catalog">
        <div class="section-header">
          <h2>Corporate Apparel Catalog</h2>
          <p>Professional branded apparel with volume pricing. Minimum order: 24 pieces per item.</p>
        </div>
        <div id="productGrid" class="products-grid"></div>
      </div>

      <!-- Quote Sidebar -->
      <div class="quote-sidebar">
        <div class="quote-header">
          <h2>Your Quote</h2>
          <p>Instant pricing with volume discounts</p>
        </div>

        <div class="quote-section">
          <h3>Tax Calculator</h3>
          <div class="tax-calculator">
            <input id="zipCode" class="zip-input" type="text" placeholder="ZIP code" maxlength="10"/>
            <button class="btn-secondary" onclick="calculateTax()">Calculate</button>
          </div>
          <div id="taxResult" style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;"></div>
        </div>

        <div class="quote-section" style="padding-bottom: 8px;">
          <h3>Quote Items</h3>
        </div>

        <div class="quote-items-wrapper">
          <div id="quoteItems" class="quote-items">
            <div class="empty-quote">
              <div class="empty-quote-icon">📋</div>
              <p>Add quantities above to build your quote</p>
            </div>
          </div>
        </div>

        <div class="quote-totals">
          <div class="total-line">
            <span>Subtotal</span>
            <span id="subtotalAmount" class="total-value">$0.00</span>
          </div>
          <div class="total-line">
            <span>Shipping</span>
            <span class="total-value" style="color: #059669;">FREE</span>
          </div>
          <div class="total-line">
            <span>Tax</span>
            <span id="taxAmount" class="total-value">$0.00</span>
          </div>
          <div class="total-line">
            <span>Total Quote</span>
            <span id="totalAmount">$0.00</span>
          </div>
        </div>
        
        <div id="invoiceSection" class="invoice-section" style="display: none;">
          <button id="createInvoiceBtn" class="btn-invoice" onclick="createInvoice()">
            <span class="btn-icon">📄</span>
            Create Invoice
          </button>
          <p class="invoice-note">Generate a professional invoice for this quote</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State Management
    let products = [];
    let quote = [];
    let taxRate = 0;
    let taxAmount = 0;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      const usp = new URLSearchParams(window.location.search);
      if (usp.get('success')) showStatus('Payment successful.');
      if (usp.get('canceled')) showError('Payment canceled.');
      await loadProducts();
      updateQuoteDisplay();
    });

    // Utility Functions
    function showStatus(message) {
      const el = document.getElementById('statusMsg');
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 5000);
    }

    function showError(message) {
      const el = document.getElementById('errorMsg');
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 8000);
    }

    function mirrorEmail() {
      const customerEmail = document.getElementById('customerEmail')?.value?.trim();
      if (customerEmail) {
        document.getElementById('toolbarEmail').value = customerEmail;
        loadProducts();
      }
    }

    async function reloadWithEmail() {
      await loadProducts();
    }

    // Product Loading
    async function loadProducts() {
      try {
        const email = document.getElementById('toolbarEmail').value.trim();
        const url = email ? `/api/products?customerEmail=${encodeURIComponent(email)}` : '/api/products';
        const response = await fetch(url);
        products = await response.json();
        renderProducts();
      } catch (error) {
        console.error('Failed to load products:', error);
        showError('Failed to load products. Please try again.');
        products = [];
        renderProducts();
      }
    }

    // Product Rendering
    function renderProducts() {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = products.map(product => {
        const imageStyle = product.previewImageUrl 
          ? `style="background-image: url('${product.previewImageUrl}')"` 
          : '';
        
        const tiers = (product.pricingTable || []).map(tier => `
          <div class="pricing-tier" data-range="${tier.quantity_range}">
            <span>${tier.quantity_range}</span>
            <span>${tier.price_per_unit}</span>
          </div>
        `).join('');

        return `
          <div class="product-card">
            <div class="product-image" ${imageStyle}>
              ${!product.previewImageUrl ? 'Branded mockup will appear here' : ''}
            </div>
            <div class="product-content">
              <div class="product-header">
                <h3 class="product-name">${product.name}</h3>
                <div class="product-sku">${product.sku}</div>
              </div>
              <p class="product-description">${product.description}</p>
              
              <div class="pricing-tiers">
                ${tiers}
              </div>

              <div class="quantity-section">
                <div class="quantity-label">Quantity</div>
                <div class="quantity-controls">
                  <button class="qty-btn" onclick="updateQuantity('${product.id}', -1)">−</button>
                  <input class="qty-input" id="qty-${product.id}" type="number" value="0" min="0" 
                         onchange="recalculateProduct('${product.id}')" />
                  <button class="qty-btn" onclick="updateQuantity('${product.id}', 1)">+</button>
                </div>
              </div>

              <div class="product-pricing">
                <div class="current-price" id="price-${product.id}">$0.00</div>
                <div class="price-breakdown" id="breakdown-${product.id}">Select quantity for pricing</div>
                <div class="savings" id="savings-${product.id}"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Initialize all product calculations
      products.forEach(product => recalculateProduct(product.id));
    }

    // Quantity Management
    function updateQuantity(productId, delta) {
      const input = document.getElementById(`qty-${productId}`);
      const currentQty = parseInt(input.value || '0', 10);
      const newQty = Math.max(0, currentQty + delta);
      input.value = newQty;
      recalculateProduct(productId);
    }

    function findUnitPrice(product, quantity) {
      const qty = Math.max(0, parseInt(quantity || '0', 10));
      if (qty === 0) return 0;
      
      const tier = product.pricing.find(p => 
        qty >= p.minQty && (p.maxQty === null || qty <= p.maxQty)
      );
      return tier ? tier.price : product.pricing[0].price;
    }

    function recalculateProduct(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const qty = parseInt(document.getElementById(`qty-${productId}`).value || '0', 10);
      const unitPrice = findUnitPrice(product, qty);
      const totalPrice = unitPrice * qty;

      // Update price display
      const priceEl = document.getElementById(`price-${product.id}`);
      const breakdownEl = document.getElementById(`breakdown-${product.id}`);
      const savingsEl = document.getElementById(`savings-${product.id}`);

      if (qty === 0) {
        priceEl.textContent = '$0.00';
        breakdownEl.textContent = 'Select quantity for pricing';
        savingsEl.textContent = '';
      } else {
        priceEl.textContent = `$${totalPrice.toFixed(2)}`;
        breakdownEl.textContent = `${qty} × $${unitPrice.toFixed(2)} each`;
        
        // Calculate savings
        const basePrice = product.pricing[0].price;
        const savings = (basePrice - unitPrice) * qty;
        savingsEl.textContent = savings > 0 ? `You save $${savings.toFixed(2)}` : '';
      }

      // Highlight active pricing tier
      const card = document.querySelector(`#qty-${productId}`).closest('.product-card');
      if (card) {
        card.querySelectorAll('.pricing-tier').forEach(tierEl => {
          const range = tierEl.dataset.range;
          const tier = product.pricing.find(p => {
            const rangeStr = p.maxQty ? `${p.minQty}-${p.maxQty}` : `${p.minQty}+`;
            return range === rangeStr;
          });
          const isActive = tier && qty >= tier.minQty && (tier.maxQty === null || qty <= tier.maxQty);
          tierEl.classList.toggle('active', isActive && qty > 0);
        });
      }

      updateQuoteItems();
    }

    // Quote Management
    function updateQuoteItems() {
      quote = [];
      
      products.forEach(product => {
        const qty = parseInt(document.getElementById(`qty-${product.id}`).value || '0', 10);
        if (qty > 0) {
          const unitPrice = findUnitPrice(product, qty);
          quote.push({
            productId: product.id,
            product: product,
            quantity: qty,
            unitPrice: unitPrice,
            totalPrice: unitPrice * qty
          });
        }
      });

      updateQuoteDisplay();
    }

    function updateQuoteDisplay() {
      const itemsContainer = document.getElementById('quoteItems');
      const subtotalEl = document.getElementById('subtotalAmount');
      const taxAmountEl = document.getElementById('taxAmount');
      const totalEl = document.getElementById('totalAmount');

      if (quote.length === 0) {
        itemsContainer.innerHTML = `
          <div class="empty-quote">
            <div class="empty-quote-icon">📋</div>
            <p>Add quantities above to build your quote</p>
          </div>
        `;
        subtotalEl.textContent = '$0.00';
        taxAmountEl.textContent = '$0.00';
        totalEl.textContent = '$0.00';
        return;
      }

      // Render quote items
      const itemsHtml = quote.map(item => `
        <div class="quote-item">
          <div class="item-details">
            <h4>${item.product.name}</h4>
            <div class="item-meta">Qty: ${item.quantity} × $${item.unitPrice.toFixed(2)}</div>
            <button class="remove-btn" onclick="removeFromQuote('${item.productId}')">Remove</button>
          </div>
          <div class="item-price">
            <div class="item-total">$${item.totalPrice.toFixed(2)}</div>
          </div>
        </div>
      `).join('');

      itemsContainer.innerHTML = itemsHtml;

      // Calculate totals
      const subtotal = quote.reduce((sum, item) => sum + item.totalPrice, 0);
      const calculatedTax = subtotal * taxRate;
      const total = subtotal + calculatedTax;

      subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
      taxAmountEl.textContent = `$${calculatedTax.toFixed(2)}`;
      totalEl.textContent = `$${total.toFixed(2)}`;

      taxAmount = calculatedTax;

      // Show/hide invoice section based on quote content
      const invoiceSection = document.getElementById('invoiceSection');
      if (invoiceSection) {
        invoiceSection.style.display = quote.length > 0 ? 'block' : 'none';
      }
    }

    function removeFromQuote(productId) {
      document.getElementById(`qty-${productId}`).value = '0';
      recalculateProduct(productId);
    }

    // Tax Calculator
    async function calculateTax() {
      const zipCode = document.getElementById('zipCode').value.trim();
      const taxResult = document.getElementById('taxResult');
      
      if (!zipCode) {
        taxResult.textContent = 'Please enter a ZIP code';
        return;
      }

      if (quote.length === 0) {
        taxResult.textContent = 'Add items to quote first';
        return;
      }

      try {
        taxResult.textContent = 'Calculating...';
        
        const response = await fetch('/api/calculate-tax', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            zipCode: zipCode,
            items: quote.map(item => ({
              productId: item.productId,
              quantity: item.quantity,
              unitPrice: item.unitPrice
            }))
          })
        });

        const data = await response.json();
        
        if (data.error) {
          taxResult.textContent = `Error: ${data.error}`;
          taxRate = 0;
        } else {
          taxRate = data.taxRate || 0;
          taxResult.textContent = `Tax rate: ${(taxRate * 100).toFixed(2)}% for ${zipCode}`;
        }
        
        updateQuoteDisplay();
      } catch (error) {
        console.error('Tax calculation failed:', error);
        taxResult.textContent = 'Tax calculation failed';
        taxRate = 0;
        updateQuoteDisplay();
      }
    }

    // Invoice Creation
    async function createInvoice() {
      if (quote.length === 0) {
        showError('Please add items to your quote first');
        return;
      }

      const customerEmail = document.getElementById('toolbarEmail').value.trim();
      if (!customerEmail) {
        showError('Please enter a customer email address');
        return;
      }

      const btn = document.getElementById('createInvoiceBtn');
      const originalText = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-icon">⏳</span> Creating Invoice...';

        // Prepare invoice data
        const invoiceData = {
          customerInfo: {
            email: customerEmail,
            name: customerEmail.split('@')[0] // Simple name extraction
          },
          products: quote.map(item => ({
            productId: item.productId,
            quantity: item.quantity,
            unitPrice: item.unitPrice
          })),
          shippingAddress: {
            line1: '123 Business St', // Placeholder - in real implementation, collect this
            city: 'Business City',
            state: 'CA',
            postal_code: document.getElementById('zipCode').value || '90210',
            country: 'US'
          }
        };

        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });

        const data = await response.json();

        if (data.error) {
          showError(`Invoice creation failed: ${data.error}`);
        } else if (data.url) {
          showStatus('Invoice created successfully! Redirecting to payment...');
          setTimeout(() => {
            window.open(data.url, '_blank');
          }, 1000);
        } else {
          showError('Unexpected response from server');
        }

      } catch (error) {
        console.error('Invoice creation failed:', error);
        showError('Failed to create invoice. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
  </script>
</body>
</html>