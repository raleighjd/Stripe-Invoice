<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Directum Supply Co. - Interactive Quote</title>
  <link rel="icon" type="image/png" href="images/red-favicon-logo.png">
  <style>
    :root{
      --bg: #FAFBFC;
      --surface: #FFFFFF;
      --text: #1A202C;         
      --muted: #4A5568;        
      --line: #E2E8F0;         
      --primary: #E53E3E;      /* Directum red */
      --primary-600: #C53030;  
      --primary-light: #FED7D7;
      --accent: #38A169;       /* Green for savings */
      --success: #38A169;      
      --danger: #E53E3E;       
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Inter',Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height: 1.6;
    }

    .wrap{max-width:1400px;margin:0 auto;padding:24px}

    /* Header */
    .header{
      margin-bottom:32px;
      border-bottom: 2px solid var(--line);
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .logo{
      height: 80px;
      width:auto;
      max-width: 200px;
      border-radius: 8px;
      object-fit: contain;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    .logo:hover{
      transform: scale(1.05);
    }
    
    .tools input:focus, #customerEmail:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
      outline: none;
    }
    .btn{
      height:44px;padding:0 20px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--primary);font-weight:600;cursor:pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .btn:hover{
      border-color:var(--primary);
      background: var(--primary-light);
      transform: translateY(-1px);
    }
    /* Layout */
    .main{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:32px;
      align-items: start;
    }
    .panel{
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow: hidden;
    }

    /* Section headers */
    .section-header{
      padding:24px 24px 20px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(135deg, #FAFBFC 0%, #F7FAFC 100%);
    }
    .section-header h2{
      margin:0;font-size:18px;font-weight:700;letter-spacing:-0.3px;
      color: var(--text);
    }
    .section-header p{
      margin: 8px 0 0;
      font-size: 14px;
      color: var(--muted);
    }

    /* Products Grid */
    .products{
      padding:24px;
      display:grid;gap:24px;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
    }
    .product-card{
      border:1px solid var(--line);
      border-radius:var(--radius-sm);
      overflow:hidden;
      background:#fff;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .product-card:hover{
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
      border-color: rgba(229, 62, 62, 0.2);
    }

    .product-image{
      height:240px;
      background:#F8F9FA;
      border-bottom:1px solid var(--line);
      background-size:cover;
      background-repeat:no-repeat;
      background-position:center;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9CA3AF;
      font-size:14px;
      position: relative;
      overflow: hidden;
    }
    .product-image::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(229, 62, 62, 0.05), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .product-card:hover .product-image::after {
      opacity: 1;
    }

    .product-info{
      padding:20px;
    }
    .product-name{
      font-size:16px;
      font-weight:700;
      margin-bottom:6px;
      color: var(--text);
      line-height: 1.3;
    }
    .product-sku{
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
      font-family: 'SF Mono', Monaco, monospace;
      background: #F7FAFC;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .product-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.5;
      margin-bottom:16px;
    }

    /* Pricing Tiers */
    .pricing-tiers{
      background:#F8FAFC;
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px;
      margin-bottom:16px;
    }
    .pricing-tier{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      padding:8px 12px;
      border-radius:8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .pricing-tier.active{
      background: linear-gradient(135deg, #FED7D7, #FEB2B2);
      color: #742A2A;
      font-weight: 600;
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(229, 62, 62, 0.2);
    }

    /* Quantity Controls */
    .quantity-controls{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .qty-btn{
      width:40px;
      height:40px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .qty-btn:hover{
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: scale(1.1);
    }
    .qty-input{
      width:80px;
      height:40px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 12px;
      text-align: center;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .qty-input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
      outline: none;
    }

    .product-price{
      font-size:16px;
      font-weight:800;
      color:var(--primary);
      margin-bottom:8px;
    }
    .savings-badge{
      display:inline-block;
      font-size:12px;
      color:var(--accent);
      background: #F0FFF4;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      margin-bottom:12px;
    }

    /* Quote Sidebar */
    .quote-sidebar{
      position:sticky;
      top:24px;
    }
    .quote-section{
      padding:20px;
      border-bottom:1px solid var(--line);
    }
    .quote-section:last-child{
      border-bottom:none;
    }

    .quote-items{
      max-height: 300px;
      overflow-y: auto;
    }
    .quote-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
      border:1px solid var(--line);
      border-radius:10px;
      margin-bottom:12px;
      background:#fff;
      transition: all 0.3s ease;
    }
    .quote-item:hover{
      transform: translateX(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .item-info{
      flex: 1;
    }
    .item-name{
      font-weight:600;
      font-size:14px;
      margin-bottom:4px;
    }
    .item-details{
      font-size:12px;
      color:var(--muted);
    }
    .remove-btn{
      padding: 6px 12px;
      border:1px solid #E53E3E;
      background:#fff;
      color:#E53E3E;
      border-radius:8px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .remove-btn:hover{
      background:#FED7D7;
      transform: scale(1.05);
    }

    .quote-totals{
      border-top:1px solid var(--line);
      padding-top:16px;
      margin-top:16px;
    }
    .total-line{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:8px 0;
      font-weight: 500;
    }
    .grand-total{
      font-weight:800;
      font-size:18px;
      color:var(--text);
      border-top:1px solid var(--line);
      padding-top:12px;
      margin-top:12px;
    }

    .quote-actions{
      margin-top:20px;
    }
    .primary-btn{
      width: 100%;
      height:48px;
      border:none;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .primary-btn::before{
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      transition: all 0.4s ease;
      transform: translate(-50%, -50%);
      border-radius: 50%;
    }
    .primary-btn:hover::before{
      width: 300px;
      height: 300px;
    }
    .primary-btn:hover{
      background: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
    }

    .help-text{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-top:12px;
      text-align: center;
    }

    /* Status Messages */
    .message{
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
    }
    .message.success{
      background: #F0FFF4;
      color: #22543D;
      border: 1px solid #9AE6B4;
    }
    .message.error{
      background: #FED7D7;
      color: #742A2A;
      border: 1px solid #FEB2B2;
    }

    /* Empty States */
    .empty-state{
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state h3{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
    }
    .empty-state p{
      margin: 0;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1200px){
      .products{
        grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
      }
    }
    @media (max-width: 1024px){
      .main{
        grid-template-columns:1fr;
      }
      .quote-sidebar{
        position:static;
      }
    }
    @media (max-width: 768px){
      .products{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Promotional Banner -->
  <div style="background: linear-gradient(135deg, #E53E3E, #C53030); color: white; text-align: center; padding: 12px 0; font-size: 14px; font-weight: 600;">
    🔥 Premium Custom Apparel with Fast Turnaround - Get Your Quote Today! 
    <a href="#" style="color: white; text-decoration: underline; margin-left: 12px; font-weight: 700;">Get Started</a>
  </div>

  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0; text-align: left; padding-left: 40px;">
        <img src="images/red-long-logo.png" alt="Directum Supply Co." class="logo" id="brandLogo">
        <div style="display: flex; align-items: center; gap: 24px; font-size: 14px; color: var(--muted);">
          <div style="display: flex; align-items: center; gap: 8px;">
            📞 <span style="color: var(--primary); font-weight: 600;">Call Sales: 1-800-DIRECTUM</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            💬 <span style="color: var(--primary); font-weight: 600; cursor: pointer;">Chat with Expert</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            📍 <span>Serving Nationwide</span>
          </div>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-top: 1px solid var(--line);">
        <div style="display: flex; align-items: center; gap: 16px;">
          <input type="search" placeholder="Search products..." style="height: 40px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--line); width: 300px;"/>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <input id="customerEmail" type="email" placeholder="Enter email for branded mockups" style="height: 40px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--line);"/>
          <button class="btn" onclick="loadBrandedMockups()">Load Mockups</button>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button style="background: none; border: none; color: var(--text); font-size: 14px; font-weight: 600; cursor: pointer;">
              👤 Sign In
            </button>
            <button style="background: none; border: none; color: var(--text); font-size: 18px; cursor: pointer; position: relative;">
              🛒
              <span style="position: absolute; top: -8px; right: -8px; background: var(--primary); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600;">0</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="message" style="display:none;"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Product Catalog -->
      <div class="panel">
        <div class="section-header">
          <h2>Product Catalog</h2>
          <p>Select quantities to build your custom quote</p>
        </div>
        <div id="productGrid" class="products"></div>
      </div>

      <!-- Quote Sidebar -->
      <div class="panel quote-sidebar">
        <div class="section-header">
          <h2>Your Quote</h2>
          <p>Live pricing updates as you select</p>
        </div>
        
        <div class="quote-section">
          <div id="quoteItems" class="quote-items"></div>
        </div>

        <div class="quote-section">
          <label style="font-size:12px;color:var(--muted);margin-bottom:8px;display:block;font-weight:600;">ZIP Code (for tax estimate)</label>
          <input id="taxZip" type="text" placeholder="Enter ZIP code" style="width:100%;height:40px;padding:0 12px;border-radius:8px;border:1px solid var(--line);margin-top:8px;" oninput="calculateTax()"/>
        </div>
        
        <div class="quote-section">
          <div class="quote-actions">
            <button id="checkoutBtn" class="primary-btn" onclick="proceedToCheckout()">
              🚀 Get Final Quote & Checkout
            </button>
            <div class="help-text">
              Stripe will collect shipping details and calculate final pricing
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let products = [];
    let quote = [];
    let taxAmount = 0;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('success')) showMessage('Payment completed successfully!', 'success');
      if (params.get('canceled')) showMessage('Payment was canceled.', 'error');
      
      // Handle logo fallback with debugging
      const logo = document.getElementById('brandLogo');
      let logoFallbackAttempted = false;
      
      // Test if logo loads
      logo.onload = function() {
        console.log('✅ Logo loaded successfully:', this.src);
      };
      
      logo.onerror = function() {
        // Prevent infinite loop
        if (logoFallbackAttempted) {
          console.log('⚠️ Fallback SVG also failed, removing error handler');
          this.onerror = null;
          return;
        }
        
        logoFallbackAttempted = true;
        console.log('❌ Logo failed to load:', this.src);
        console.log('🔍 Check if file exists at: /public/images/red-long-logo.png');
        
        // Use a simpler fallback that won't fail
        this.style.display = 'none';
        const fallbackText = document.createElement('div');
        fallbackText.innerHTML = '<span style="color: #E53E3E; font-weight: 800; font-size: 18px;">Directum Supply Co.</span>';
        this.parentNode.insertBefore(fallbackText, this.nextSibling);
        
        console.log('🎨 Using text fallback');
      };
      
      // Test logo path immediately
      const testImg = new Image();
      testImg.onload = () => console.log('✅ Logo path test successful');
      testImg.onerror = () => console.log('❌ Logo path test failed - file may not exist at: public/images/red-long-logo.png');
      testImg.src = 'images/red-long-logo.png';
      
      await loadProducts();
      updateQuoteDisplay();
    });

    // Messages
    function showMessage(text, type = 'success') {
      const el = document.getElementById('statusMessage');
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    // Load products
    async function loadProducts() {
      try {
        console.log('Loading products...');
        const email = (document.getElementById('customerEmail')?.value || '').trim();
        const url = email ? `/api/products?customerEmail=${encodeURIComponent(email)}` : '/api/products';
        
        console.log('Fetching from:', url);
        const resp = await fetch(url, { cache: 'no-store' });
        console.log('Response status:', resp.status);
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        
        const payload = await resp.json();
        console.log('Received payload:', payload);

        // Accept either an array or an object with a products array
        products = Array.isArray(payload) ? payload : (payload?.products || []);
        if (!Array.isArray(products)) products = [];
        
        console.log('Processed products:', products.length);
        renderProducts(products);
        showMessage(`Loaded ${products.length} products`, 'success');
        
      } catch (err) {
        console.error('loadProducts error:', err);
        products = [];
        renderProducts([]);
        showMessage('Could not load products: ' + err.message, 'error');
      }
    }

    // Render products
    function renderProducts(products) {
      const container = document.getElementById('productGrid');
      if (!container) return;

      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No products available</h3>
            <p>Please check back later</p>
          </div>
        `;
        return;
      }

      const html = products.map(product => {
        const imageUrl = product.previewImageUrl || product.baseImageUrl || '';
        const basePrice = product.currentPrice || (product.pricing && product.pricing[0] ? product.pricing[0].price : 0);
        
        // Generate pricing tiers HTML
        const pricingTiersHtml = product.pricing ? product.pricing.map(tier => {
          const range = tier.maxQty ? `${tier.minQty}-${tier.maxQty}` : `${tier.minQty}+`;
          return `
            <div class="pricing-tier" data-range="${range}">
              <span>${range}</span>
              <span>$${Number(tier.price || 0).toFixed(2)}</span>
            </div>
          `;
        }).join('') : '';
        
        return `
          <div class="product-card" data-product-id="${product.id}">
            <div class="product-image" style="background-image:url('${imageUrl}');">
              ${!imageUrl ? 'No Image Available' : ''}
            </div>
            <div class="product-info">
              <div class="product-name">${product.name || ''}</div>
              <div class="product-sku">${product.sku || ''}</div>
              <div class="product-desc">${product.description || ''}</div>
              
              ${pricingTiersHtml ? `
                <div class="pricing-tiers">
                  ${pricingTiersHtml}
                </div>
              ` : ''}
              
              <div class="quantity-controls">
                <button class="qty-btn" onclick="adjustQuantity('${product.id}', -1)">−</button>
               <input id="qty-${product.id}" class="qty-input" type="number" value="0" min="0" onchange="updateProductPricing('${product.id}')" oninput="updateProductPricing('${product.id}')">
                <button class="qty-btn" onclick="adjustQuantity('${product.id}', 1)">+</button>
              </div>
              
              <div id="price-${product.id}" class="product-price">Starting at $${basePrice.toFixed(2)}</div>
              <div id="savings-${product.id}" class="savings-badge" style="display:none;"></div>
              
              <button class="btn" style="width: 100%; margin-top: 12px; background: var(--primary); color: white; border-color: var(--primary);" onclick="generateMockup('${product.id}')">
                🎨 Generate Mockup
              </button>
              
              <button class="btn" style="width: 100%; margin-top: 8px; background: var(--accent); color: white; border-color: var(--accent);" onclick="openBBoxModal('${product.id}')">
                📐 Set Logo Position
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Handle image fallback for failed preview images
      setTimeout(() => {
        products.forEach(product => {
          if (product.previewImageUrl && product.baseImageUrl) {
            const productCard = container.querySelector(`[data-product-id="${product.id}"]`);
            const imageDiv = productCard?.querySelector('.product-image');
            if (imageDiv) {
              // Test if preview image loads
              const testImg = new Image();
              testImg.onload = () => {
                // Preview image loaded successfully, keep it
                console.log('✅ Preview image loaded for', product.name);
              };
              testImg.onerror = () => {
                // Preview image failed, fallback to base image
                console.log('⚠️ Preview image failed, falling back to base image for', product.name);
                imageDiv.style.backgroundImage = `url('${product.baseImageUrl}')`;
              };
              testImg.src = product.previewImageUrl;
            }
          }
        });
      }, 100);
    }

    // Load branded mockups
    function loadBrandedMockups() {
      console.log('Loading branded mockups...');
      showMessage('Loading products with branded mockups...', 'success');
      loadProducts();
    }

    // Open BBox Modal for positioning
    function openBBoxModal(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) {
        showMessage('Product not found', 'error');
        return;
      }
      
      // Create modal if it doesn't exist
      let modal = document.getElementById('bboxModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bboxModal';
        modal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:#fff; border-radius:12px; padding:16px; max-width:90vw; max-height:90vh;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <strong id="bboxTitle">Set Logo Position</strong>
              <span style="flex:1"></span>
              <button id="bboxClose" style="border:none;background:#eee;padding:6px 10px;border-radius:6px;cursor:pointer;">Close</button>
            </div>
            <div id="bboxCanvasWrap" style="position:relative; overflow:auto; border:1px solid #eee; border-radius:8px;">
              <img id="bboxImg" src="" alt="product" style="max-width:85vw; max-height:70vh; display:block;">
              <canvas id="bboxCanvas" style="position:absolute; left:0; top:0;"></canvas>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
              <label>Area name</label>
              <input id="bboxAreaName" type="text" value="right_chest" style="padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
              <span style="flex:1"></span>
              <button id="bboxClear" style="background:#eee;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Clear</button>
              <button id="bboxSave"  style="background:#111;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Save Position</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }
      
      const imgEl = document.getElementById('bboxImg');
      const canvas = document.getElementById('bboxCanvas');
      const title = document.getElementById('bboxTitle');
      const areaInput = document.getElementById('bboxAreaName');
      
      title.textContent = `Set Logo Position — ${product.name}`;
      imgEl.src = product.baseImageUrl;
      
      let start = null;
      let rect = null;
      
      function resizeCanvas() {
        canvas.width  = imgEl.clientWidth;
        canvas.height = imgEl.clientHeight;
        canvas.style.width  = imgEl.clientWidth + 'px';
        canvas.style.height = imgEl.clientHeight + 'px';
        draw();
      }
      
      function draw() {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (!rect) return;
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#e53e3e';
        ctx.setLineDash([6,4]);
        const {x,y,w,h} = rect;
        ctx.strokeRect(x,y,w,h);
      }
      
      function toNaturalCoords(r) {
        const scaleX = imgEl.naturalWidth  / imgEl.clientWidth;
        const scaleY = imgEl.naturalHeight / imgEl.clientHeight;
        const x1 = Math.round(r.x * scaleX);
        const y1 = Math.round(r.y * scaleY);
        const x2 = Math.round((r.x + r.w) * scaleX);
        const y2 = Math.round((r.y + r.h) * scaleY);
        return { x1, y1, x2, y2 };
      }
      
      function onDown(ev) {
        const b = canvas.getBoundingClientRect();
        start = { x: ev.clientX - b.left, y: ev.clientY - b.top };
        rect = { x:start.x, y:start.y, w:0, h:0 };
        draw();
      }
      function onMove(ev) {
        if (!start) return;
        const b = canvas.getBoundingClientRect();
        const x = ev.clientX - b.left, y = ev.clientY - b.top;
        rect.w = x - rect.x; rect.h = y - rect.y;
        draw();
      }
      function onUp() { start = null; }
      
      function clearBox() { rect = null; draw(); }
      
      async function saveBox() {
        if (!rect) { 
          showMessage('Draw a box first by clicking and dragging on the image', 'error'); 
          return; 
        }
        const n = toNaturalCoords({
          x: Math.min(rect.x, rect.x+rect.w),
          y: Math.min(rect.y, rect.y+rect.h),
          w: Math.abs(rect.w),
          h: Math.abs(rect.h)
        });
        const payload = {
          boxes: [{ name: (areaInput.value || 'right_chest'), x1:n.x1, y1:n.y1, x2:n.x2, y2:n.y2 }]
        };
        
        try {
          const response = await fetch(`/api/products/${encodeURIComponent(product.id)}/boxes`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          if (!response.ok || !result.ok) {
            throw new Error(result.error || 'Save failed');
          }
          showMessage('✅ Logo position saved successfully!', 'success');
          close();
        } catch (err) {
          console.error(err);
          showMessage('❌ Failed to save position: ' + err.message, 'error');
        }
      }
      
      function open() {
        modal.style.display = 'flex';
        setTimeout(() => resizeCanvas(), 50);
      }
      function close() {
        modal.style.display = 'none';
        canvas.removeEventListener('mousedown', onDown);
        canvas.removeEventListener('mousemove', onMove);
        canvas.removeEventListener('mouseup',   onUp);
      }
      
      document.getElementById('bboxClose').onclick = close;
      document.getElementById('bboxClear').onclick = clearBox;
      document.getElementById('bboxSave').onclick  = saveBox;
      imgEl.onload = resizeCanvas;
      window.addEventListener('resize', resizeCanvas);
      
      canvas.addEventListener('mousedown', onDown);
      canvas.addEventListener('mousemove', onMove);
      canvas.addEventListener('mouseup',   onUp);
      
      open();
    }
    function adjustQuantity(productId, delta) {
      const input = document.getElementById(`qty-${productId}`);
      const newValue = Math.max(0, parseInt(input.value || '0') + delta);
      input.value = newValue;
      updateProductPricing(productId);
    }

    // Calculate unit price locally
    function calculateUnitPrice(product, quantity) {
      const qty = parseInt(quantity) || 0;
      if (qty === 0) return product.currentPrice || 0;
      
      const tier = product.pricing.find(p => 
        qty >= p.minQty && (p.maxQty === null || qty <= p.maxQty)
      );
      return tier ? tier.price : product.pricing[0].price;
    }

    // Update product pricing display
    function updateProductPricing(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const quantity = parseInt(document.getElementById(`qty-${productId}`).value || '0');
      const priceEl = document.getElementById(`price-${product.id}`);
      const savingsEl = document.getElementById(`savings-${product.id}`);

      if (quantity === 0) {
        priceEl.textContent = `Starting at $${(product.currentPrice || 0).toFixed(2)}`;
        savingsEl.style.display = 'none';
        return;
      }

      const unitPrice = calculateUnitPrice(product, quantity);
      const totalPrice = unitPrice * quantity;
      priceEl.textContent = `$${totalPrice.toFixed(2)} ($${unitPrice.toFixed(2)} each)`;

      // Show savings
      const basePrice = product.currentPrice || product.pricing[0].price;
      const savings = quantity > 1 ? (basePrice - unitPrice) * quantity : 0;
      if (savings > 0) {
        savingsEl.textContent = `Save $${savings.toFixed(2)}`;
        savingsEl.style.display = 'inline-block';
      } else {
        savingsEl.style.display = 'none';
      }

      // Highlight active tier
      const card = document.getElementById(`qty-${productId}`).closest('.product-card');
      if (card) {
        card.querySelectorAll('.pricing-tier').forEach(tierEl => {
          const range = tierEl.dataset.range;
          const tier = product.pricing.find(p => {
            const tierRange = p.maxQty ? `${p.minQty}-${p.maxQty}` : `${p.minQty}+`;
            return range === tierRange;
          });
          const isActive = tier && quantity >= tier.minQty && (tier.maxQty === null || quantity <= tier.maxQty);
          tierEl.classList.toggle('active', isActive);
        });
      }
      
      // Update quote totals
      updateQuote();
    }

    // Update quote
    function updateQuote() {
      quote = [];
      products.forEach(product => {
        const quantity = parseInt(document.getElementById(`qty-${product.id}`).value || '0');
        if (quantity > 0) {
          quote.push({
            productId: product.id,
            product: product,
            quantity: quantity,
            unitPrice: calculateUnitPrice(product, quantity),
            totalPrice: calculateUnitPrice(product, quantity) * quantity
          });
        }
      });
      updateQuoteDisplay();
      calculateTax();
    }

    // Update quote display
    function updateQuoteDisplay() {
      const container = document.getElementById('quoteItems');
      
      if (quote.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No items selected</h3>
            <p>Adjust quantities above to build your quote</p>
          </div>
        `;
        return;
      }

      const subtotal = quote.reduce((sum, item) => sum + item.totalPrice, 0);
      
      const itemsHtml = quote.map(item => `
        <div class="quote-item">
          <div class="item-info">
            <div class="item-name">${item.product.name}</div>
            <div class="item-details">Qty ${item.quantity} × $${item.unitPrice.toFixed(2)} = $${item.totalPrice.toFixed(2)}</div>
          </div>
          <button class="remove-btn" onclick="removeFromQuote(${JSON.stringify(item.productId)})">Remove</button>
        </div>
      `).join('');

      container.innerHTML = `
        ${itemsHtml}
        <div class="quote-totals">
          <div class="total-line">
            <span>Subtotal</span>
            <span>$${subtotal.toFixed(2)}</span>
          </div>
          <div class="total-line">
            <span>Shipping</span>
            <span>Calculated at checkout</span>
          </div>
          <div class="total-line">
            <span>Tax</span>
            <span>${taxAmount > 0 ? '$' + taxAmount.toFixed(2) + ' (estimate)' : 'Calculated at checkout'}</span>
          </div>
          <div class="grand-total">
            <span>Quote Total</span>
            <span>$${(subtotal + taxAmount).toFixed(2)}${taxAmount === 0 ? ' + tax & shipping' : ' + shipping'}</span>
          </div>
        </div>
      `;
    }

    // Remove from quote
    function removeFromQuote(productId) {
      document.getElementById(`qty-${productId}`).value = '0';
      updateProductPricing(productId);
      updateQuote();
    }

    // Tax calculation
    async function calculateTax() {
      const zip = document.getElementById('taxZip').value.trim();
      if (!zip || quote.length === 0) {
        taxAmount = 0;
        updateQuoteDisplay();
        return;
      }

      try {
        const response = await fetch('/api/calculate-tax', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            zip: zip,
            items: quote.map(item => ({
              productId: item.productId,
              quantity: item.quantity,
              unitPrice: item.unitPrice
            }))
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          taxAmount = data.taxAmount || 0;
        } else {
          taxAmount = 0;
        }
      } catch (error) {
        console.error('Tax calculation failed:', error);
        taxAmount = 0;
      }
      
      updateQuoteDisplay();
    }

    // Proceed to checkout
    async function proceedToCheckout() {
      if (quote.length === 0) {
        showMessage('Please add items to your quote first', 'error');
        return;
      }

      const btn = document.getElementById('checkoutBtn');
      btn.disabled = true;
      btn.textContent = 'Creating checkout session...';

      try {
        const customerEmail = document.getElementById('customerEmail').value.trim();
        
        const payload = {
          customerInfo: { 
            name: '', 
            email: customerEmail || '', 
            company: '', 
            phone: '' 
          },
          products: quote.map(item => ({ 
            productId: item.productId, 
            quantity: item.quantity 
          })),
          shippingAddress: { 
            line1: 'TBD', city: 'TBD', state: 'TBD', 
            postal_code: 'TBD', country: 'US' 
          },
          billingAddress: { 
            line1: 'TBD', city: 'TBD', state: 'TBD', 
            postal_code: 'TBD', country: 'US' 
          }
        };

        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();

        if (data.url) {
          showMessage('Redirecting to secure checkout...', 'success');
          window.location = data.url;
        } else {
          showMessage('Checkout failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showMessage('Checkout failed: ' + error.message, 'error');
        console.error('Checkout error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = '🚀 Get Final Quote & Checkout';
      }
    }

    // Generate mockup for specific product
    async function generateMockup(productId) {
      console.log('Generating mockup for product:', productId);
      
      let email = document.getElementById('customerEmail').value.trim();
      let logoUrl = null;

      // If email is provided, try to fetch their logo from S3
      if (!email) {
        showMessage('Please enter a customer email first, or we\'ll ask you to upload a logo file.', 'error');
        // For now, let's still ask for manual logo URL if no email
        logoUrl = prompt('No email provided. Please enter logo URL:');
        if (!email) {
          showMessage('Logo URL is required for mockup generation', 'error');
          return;
        }
      } else {
        // Try to fetch logo from S3 for this customer
        try {
          showMessage('Looking for existing logo in S3...', 'success');
          const logoResponse = await fetch(`/api/customer/${encodeURIComponent(email)}/logo`);
          const logoData = await logoResponse.json();
          
          if (logoData.hasLogo) {
            logoUrl = logoData.logoUrl;
            showMessage(`Found logo: ${logoData.filename}`, 'success');
          } else {
            // No logo found, ask for upload or URL
            const userChoice = confirm(
              'No logo found in S3 for this customer email.\n\n' +
              'Click OK to provide a logo URL, or Cancel to upload a file later.'
            );
            
            if (userChoice) {
              logoUrl = prompt('Please enter logo URL:');
              if (!logoUrl) {
                showMessage('Logo URL is required for mockup generation', 'error');
                return;
              }
            } else {
              showMessage('Please upload a logo file to S3 first, then try again.', 'error');
              return;
            }
          }
        } catch (error) {
          console.error('Error fetching logo:', error);
          showMessage('Could not check for existing logo. Please provide logo URL.', 'error');
          logoUrl = prompt('Please enter logo URL:');
          if (!logoUrl) {
            showMessage('Logo URL is required for mockup generation', 'error');
            return;
          }
        }
      }
      
      // Ensure we have both email and logoUrl at this point
      if (!email || !logoUrl) {
        showMessage('Both email and logo are required for mockup generation', 'error');
        return;
      }
      
      // Find the button to show loading state
      const button = event.target;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = '⏳ Generating...';
      
      try {
        showMessage('Generating mockup and uploading to S3...', 'success');
        
        const response = await fetch(`/api/products/${encodeURIComponent(productId)}/mockup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, logoUrl })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.ok) {
          throw new Error(result.error || 'Mockup generation failed');
        }
        
        showMessage(`✅ Mockup generated and uploaded to S3! Refreshing products...`, 'success');
        
        // Refresh products to show the new mockup
        await loadProducts();
        
      } catch (error) {
        console.error('Mockup generation error:', error);
        showMessage(`❌ Mockup generation failed: ${error.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }
  </script>
</body>
</html>